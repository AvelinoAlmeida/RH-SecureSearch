<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Métricas de desempenho</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      :root { --brand: #0f172a; }
      body { background: #f6f7fb; }
      .brandbar { background: var(--brand); }
      .logo { height: 34px; width: auto; }
      .card { border: 0; border-radius: 16px; }
      .shadow-soft { box-shadow: 0 10px 24px rgba(15, 23, 42, .08); }
      .muted { color: #64748b; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .table thead th { position: sticky; top: 0; z-index: 2; background: #fff; }
      .kpi { border-radius: 16px; }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-dark brandbar">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/metrics">
          <img class="logo" src="{{ url_for('static', filename='image/logo.png') }}" alt="Logo RH-SecureSearch">
          <span class="fw-semibold">RH-SecureSearch</span>
        </a>
        <div class="ms-auto d-flex gap-2">
          <a class="btn btn-outline-light btn-sm" href="/">Servidor</a>
          <a class="btn btn-light btn-sm" href="/client">Cliente</a>
        </div>
      </div>
    </nav>

    <main class="container my-4 my-lg-5">
      <div class="row g-3">
        <div class="col-12">
          <div class="card shadow-soft p-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
              <div>
                <h1 class="h3 mb-1">Métricas de desempenho</h1>
                <p class="mb-0 muted">
                  KPI e percentis por operação (build/upload vs pesquisa SSE vs pesquisa em claro).
                </p>
              </div>
              <a class="btn btn-outline-dark" href="/">Voltar</a>
            </div>
          </div>
        </div>

        {% if headers and rows %}
          <div class="col-12">
            <div class="card shadow-soft p-4">
              <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
                <div>
                  <h2 class="h5 mb-1">Resumo</h2>
                  <div class="muted">Seleciona uma operação para calcular p50/p95/p99.</div>
                </div>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <label class="form-label mb-0 muted">Operação</label>
                  <select id="opSelect" class="form-select form-select-sm" style="min-width: 220px;"></select>

                  <input id="filter" class="form-control form-control-sm" style="max-width: 320px;"
                         placeholder="Filtrar (ex.: search_sse, Marketing, 0.12)">
                  <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearFilter()">Limpar</button>
                </div>
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-3">
                  <div class="card shadow-soft p-3 kpi">
                    <div class="muted mb-1">Registos</div>
                    <div class="h3 mb-0" id="kpiCount">—</div>
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <div class="card shadow-soft p-3 kpi">
                    <div class="muted mb-1">p50 total (s)</div>
                    <div class="h3 mb-0" id="kpiP50">—</div>
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <div class="card shadow-soft p-3 kpi">
                    <div class="muted mb-1">p95 total (s)</div>
                    <div class="h3 mb-0" id="kpiP95">—</div>
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <div class="card shadow-soft p-3 kpi">
                    <div class="muted mb-1">p99 total (s)</div>
                    <div class="h3 mb-0" id="kpiP99">—</div>
                  </div>
                </div>
              </div>

              <hr class="my-4">

              <div class="table-responsive" style="max-height: 560px;">
                <table class="table table-hover align-middle mb-0" id="metricsTable">
                  <thead>
                    <tr>
                      {% for h in headers %}
                        <th class="text-nowrap">{{ h }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in rows %}
                      <tr>
                        {% for cell in row %}
                          <td class="text-nowrap {% if cell is string and (cell|length > 24) %}mono{% endif %}">
                            {{ cell }}
                          </td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <div class="mt-3 muted">
                Nota: percentis são calculados no browser com base no CSV carregado. Para auditoria “forte”, o ideal é calcular no backend.
              </div>
            </div>
          </div>
        {% else %}
          <div class="col-12">
            <div class="card shadow-soft p-4">
              <div class="alert alert-warning mb-0">
                Ainda não existem métricas registadas. Corre o cliente primeiro (build-and-upload / search).
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const table = document.getElementById('metricsTable');
      const filterInput = document.getElementById('filter');
      const opSelect = document.getElementById('opSelect');

      const kpiCount = document.getElementById('kpiCount');
      const kpiP50 = document.getElementById('kpiP50');
      const kpiP95 = document.getElementById('kpiP95');
      const kpiP99 = document.getElementById('kpiP99');

      function toFloatSafe(x) {
        if (x === null || x === undefined) return null;
        const s = String(x).trim().replace(',', '.');
        if (!s) return null;
        const v = Number(s);
        return Number.isFinite(v) ? v : null;
      }

      function percentile(sortedArr, p) {
        if (!sortedArr.length) return null;
        const idx = (p / 100) * (sortedArr.length - 1);
        const lo = Math.floor(idx);
        const hi = Math.ceil(idx);
        if (lo === hi) return sortedArr[lo];
        const w = idx - lo;
        return sortedArr[lo] * (1 - w) + sortedArr[hi] * w;
      }

      function getHeaderIndexMap() {
        const ths = table.querySelectorAll('thead th');
        const map = {};
        ths.forEach((th, i) => map[th.innerText.trim().toLowerCase()] = i);
        return map;
      }

      function collectData() {
        const idx = getHeaderIndexMap();
        const iOp = idx["operação"] ?? idx["operacao"] ?? null;
        const iTotal = idx["tempo total (s)"] ?? idx["tempo pesquisa (s)"] ?? null;

        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const data = [];

        for (const tr of rows) {
          const tds = tr.querySelectorAll('td');
          const op = (iOp !== null && tds[iOp]) ? tds[iOp].innerText.trim() : "";
          const total = (iTotal !== null && tds[iTotal]) ? toFloatSafe(tds[iTotal].innerText) : null;

          data.push({ tr, op, total });
        }

        return { data, iOp, iTotal };
      }

      function buildOpSelect(data) {
        const ops = new Set(data.map(x => x.op).filter(x => x));
        const list = Array.from(ops).sort();
        opSelect.innerHTML = "";

        const optAll = document.createElement('option');
        optAll.value = "__ALL__";
        optAll.textContent = "Todas";
        opSelect.appendChild(optAll);

        for (const op of list) {
          const opt = document.createElement('option');
          opt.value = op;
          opt.textContent = op;
          opSelect.appendChild(opt);
        }
      }

      function applyFilter() {
        if (!filterInput || !table) return;
        const q = filterInput.value.trim().toLowerCase();
        const trs = table.querySelectorAll('tbody tr');
        trs.forEach(tr => {
          const text = tr.innerText.toLowerCase();
          tr.style.display = text.includes(q) ? "" : "none";
        });
        recomputeKPIs();
      }

      function clearFilter() {
        filterInput.value = "";
        applyFilter();
        filterInput.focus();
      }

      function recomputeKPIs() {
        const { data } = collectData();
        const selectedOp = opSelect.value;

        // só considerar linhas visíveis (após filtro)
        const visible = data.filter(x => x.tr.style.display !== "none");

        const subset = (selectedOp === "__ALL__")
          ? visible
          : visible.filter(x => x.op === selectedOp);

        const totals = subset.map(x => x.total).filter(v => v !== null).sort((a,b) => a-b);

        kpiCount.textContent = subset.length ? String(subset.length) : "0";

        const p50 = percentile(totals, 50);
        const p95 = percentile(totals, 95);
        const p99 = percentile(totals, 99);

        kpiP50.textContent = (p50 === null) ? "—" : p50.toFixed(3);
        kpiP95.textContent = (p95 === null) ? "—" : p95.toFixed(3);
        kpiP99.textContent = (p99 === null) ? "—" : p99.toFixed(3);
      }

      if (table && opSelect) {
        const { data } = collectData();
        buildOpSelect(data);
        opSelect.addEventListener('change', recomputeKPIs);
        if (filterInput) filterInput.addEventListener('input', applyFilter);
        // KPI inicial
        recomputeKPIs();
      }
    </script>
  </body>
</html>
